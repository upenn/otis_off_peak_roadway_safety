---
title: "Openstreetmap data download and EDA"
author: "Chi-Hyun Kim"
date: "Last updated `r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    theme: sandstone
knit: (
  function(inputFile, encoding) { 
    rmarkdown::render(
      input = inputFile, 
      encoding = encoding, 
      output_file = paste0(substr(inputFile, 1, nchar(inputFile) - 4), "_", Sys.Date(),'.html')
                     ) 
                                }
      )
---

<!-- Setting style parameters for output document -->

<style>
  body {
    font-family: "Avenir", "Helvetica Neue", Helvetica, Arial, sans-serif !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: #3e3f3a;
    background-color: #ffffff
  }
  title,
  .title {
    font-size: 33px !important;
    font-weight: bold
  }
  h1,
  .h1 {
    font-size: 29px !important;
    font-weight: bold
  }
  h2,
  .h2 {
    font-size: 25px !important;
    font-weight: bold
  }
  h3,
  .h3 {
    font-size: 20px !important;
    font-style: italic
  }
  .caption {
  font-style: italic
  }
  .bold {
  font-weight: bold
  }
</style>

```{r Setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

```{r Preliminaries}

library(tidyverse)
library(tidylog)
library(janitor)
library(scales)
library(gt)
library(boxr)
library(osmdata)
library(mapview)

# Set up remote data access via Box API
box_auth()
box_raw_data_folder <- 362958311858
# Contents of raw data folder
box_raw_data_list <- box_ls(362958311858) %>% as_tibble()

box_processed_data_folder <- 362958210990

# ggplot theming
theme_set(theme_light())

```

```{r Read data}

# Define the city boundary and build query
q <- getbb("Philadelphia, PA") %>%
  opq() %>%
  # Query all highway types. In OSM terms, 'highway' means all roadways.
  add_osm_feature(key = "highway") 

# Download the data (takes a while)
philly_roads <- osmdata_sf(q)

# Isolate line-geometry data and associated attributes, standardize variable names
osm_roads_data_all <- philly_roads[["osm_lines"]] %>% 
  clean_names()

# Write out full data in case other columns are needed later
# box_save_rds(osm_roads_data_all, file_name = "osm_roads_data_all.rds", dir_id = box_processed_data_folder)

# Select needed variables
roads_with_lanes <- osm_roads_data_all %>%
  select(osm_id, name, highway, lanes) %>%
  # Keep only roads with explicit lane data
  # filter: removed 157,950 rows (90%), 17,541 rows remaining
  filter(!is.na(lanes)) 

# Write out selected data
# box_save_rds(roads_with_lanes, file_name = "osm_roads_lane_data.rds", dir_id = box_processed_data_folder)

```

# Coverage

The map below shows coverage for OSM network data including lane number information. Note that segments can be very short, depending on the roadway.


```{r Results}

# View results
mapview(roads_with_lanes, zcol = "lanes")

```









