# Understanding Off-Peak Roadway Safety in Philadelphia
## Author: Kavana Raju (crash data lead)
## Last Updated: 10 February 2026

# This script handles the full PennDOT crash database structure:
- 8 CSV files per year: CRASH, FLAG, VEHICLE, PERSON, ROADWAY, CYCLE, COMMVEH, TRAILVEH
- Years 2020-2024

```{r load-libraries}
library(tidyverse)
library(lubridate)
library(sf)
library(scales)
library(viridis)
library(knitr)
library(kableExtra)
library(patchwork)

options(scipen = 999)
```
# 1. Setup and Data Loading

```{r set-theme}
plotTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8, hjust = 0, lineheight = 1.1),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title = element_text(size = 11, face = "bold"),
  panel.background = element_blank(),
  panel.grid.major = element_line(colour = "#D0D0D0", linewidth = 0.2),
  panel.grid.minor = element_blank(),
  axis.ticks = element_blank(),
  legend.position = "right"
)

mapTheme <- theme(
  plot.title = element_text(size = 14, face = "bold"),
  plot.subtitle = element_text(size = 10),
  plot.caption = element_text(size = 8),
  axis.line = element_blank(),
  axis.text = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank(),
  panel.background = element_blank(),
  panel.border = element_blank(),
  panel.grid.major = element_line(colour = 'transparent'),
  panel.grid.minor = element_blank(),
  legend.position = "right",
  plot.margin = margin(1, 1, 1, 1, 'cm')
)

# Custom color palettes
palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
severity_colors <- c(
  "Fatal" = "#d62728",
  "Suspected Serious Injury" = "#ff7f0e", 
  "Suspected Minor Injury" = "#ffbb78",
  "Possible Injury" = "#c5b0d5",
  "PDO" = "#c7c7c7"
)
```

```{r Load-crash-data}
# Set data directory
data_dir <- "data"

# Load 2020
crash_2020 <- read_csv(file.path(data_dir, "Statewide_2020/CRASH_2020.csv"), show_col_types = FALSE)
flags_2020 <- read_csv(file.path(data_dir, "Statewide_2020/FLAGS_2020.csv"), show_col_types = FALSE)
roadway_2020 <- read_csv(file.path(data_dir, "Statewide_2020/ROADWAY_2020.csv"), show_col_types = FALSE)

# Load 2021
crash_2021 <- read_csv(file.path(data_dir, "Statewide_2021/CRASH_2021.csv"), show_col_types = FALSE)
flags_2021 <- read_csv(file.path(data_dir, "Statewide_2021/FLAGS_2021.csv"), show_col_types = FALSE)
roadway_2021 <- read_csv(file.path(data_dir, "Statewide_2021/ROADWAY_2021.csv"), show_col_types = FALSE)

# Load 2022
crash_2022 <- read_csv(file.path(data_dir, "Statewide_2022/CRASH_2022.csv"), show_col_types = FALSE)
flags_2022 <- read_csv(file.path(data_dir, "Statewide_2022/FLAGS_2022.csv"), show_col_types = FALSE)
roadway_2022 <- read_csv(file.path(data_dir, "Statewide_2022/ROADWAY_2022.csv"), show_col_types = FALSE)

# Load 2023
crash_2023 <- read_csv(file.path(data_dir, "Statewide_2023/CRASH_2023.csv"), show_col_types = FALSE)
flags_2023 <- read_csv(file.path(data_dir, "Statewide_2023/FLAGS_2023.csv"), show_col_types = FALSE)
roadway_2023 <- read_csv(file.path(data_dir, "Statewide_2023/ROADWAY_2023.csv"), show_col_types = FALSE)

# Load 2024
crash_2024 <- read_csv(file.path(data_dir, "Statewide_2024/CRASH_2024.csv"), show_col_types = FALSE)
flags_2024 <- read_csv(file.path(data_dir, "Statewide_2024/FLAGS_2024.csv"), show_col_types = FALSE)
roadway_2024 <- read_csv(file.path(data_dir, "Statewide_2024/ROADWAY_2024.csv"), show_col_types = FALSE)

crash_years <- list(crash_2020, crash_2021, crash_2022, crash_2023, crash_2024)

flag_years <- list(flags_2020, flags_2021, flags_2022, flags_2023, flags_2024)

roadway_years <- list(roadway_2020, roadway_2021, roadway_2022, roadway_2023, roadway_2024)

```

```{r fix-column-types}

# Diagnostic: Find columns with type mismatches in CRASH tables
get_column_types <- function(df) {
  sapply(df, class) %>% sapply(., `[`, 1)  # Get first class for each column
}

crash_types <- map(crash_years, get_column_types)
crash_cols <- unique(unlist(map(crash_types, names)))

# Find columns where type varies across years
mismatched_crash_cols <- crash_cols[sapply(crash_cols, function(col) {
  types <- unique(sapply(crash_types, function(x) x[col]))
  types <- types[!is.na(types)]
  length(types) > 1  # More than one type = mismatch
})]

if (length(mismatched_crash_cols) > 0) {
  cat("✗ Type mismatches found in CRASH tables:\n")
  for (col in mismatched_crash_cols) {
    types_by_year <- sapply(1:5, function(i) {
      type <- crash_types[[i]][col]
      if (is.na(type)) "missing" else type
    })
    cat(sprintf("  %s: %s\n", col, paste(types_by_year, collapse = " → ")))
  }
  cat("\n")
} else {
  cat("✓ No type mismatches in CRASH tables\n\n")
}

```
```{r mismatch-flags}

# Do same for FLAGS
flag_types <- map(flag_years, get_column_types)
flag_cols <- unique(unlist(map(flag_types, names)))

mismatched_flag_cols <- flag_cols[sapply(flag_cols, function(col) {
  types <- unique(sapply(flag_types, function(x) x[col]))
  types <- types[!is.na(types)]
  length(types) > 1
})]

if (length(mismatched_flag_cols) > 0) {
  cat("✗ Type mismatches found in FLAGS tables:\n")
  cat(sprintf("  %d columns have type inconsistencies\n\n", length(mismatched_flag_cols)))
}

```

```{r mismatch-roadway}

# Do same for ROADWAY
roadway_types <- map(roadway_years, get_column_types)
roadway_cols <- unique(unlist(map(roadway_types, names)))

mismatched_roadway_cols <- roadway_cols[sapply(roadway_cols, function(col) {
  types <- unique(sapply(roadway_types, function(x) x[col]))
  types <- types[!is.na(types)]
  length(types) > 1
})]

if (length(mismatched_roadway_cols) > 0) {
  cat("✗ Type mismatches found in ROADWAY tables:\n")
  cat(sprintf("  %d columns have type inconsistencies\n\n", length(mismatched_roadway_cols)))
}

```

```{r}
# Detects mismatches
mismatched_crash_cols <- c("WEATHER1", "TCD_FUNC_CD")

# Converts to character (most flexible type)
crash_years_harmonized <- crash_years %>%
  map(~ mutate(.x, across(all_of(mismatched_crash_cols), as.character)))

# Binds successfully
all_crashes <- bind_rows(crash_years_harmonized)

all_flags <- bind_rows(flag_years)

all_roadway <- bind_rows(roadway_years)
```


#### Deduplicate roadway (one crash can have multiple roadway records)
```{r}
all_roadway %>%
  count(CRN) %>%
  count(n, name = "num_crashes") %>%
  rename(roadway_records = n)

# Capping the number of roadways at 2
all_roadway_wide <- all_roadway %>%
  group_by(CRN) %>%
  mutate(road_num = row_number()) %>%
  filter(road_num <= 2) %>%        # Cap at 2, beyond that is noise
  ungroup() %>%
  pivot_wider(
    id_cols     = CRN,
    names_from  = road_num,
    values_from = -c(CRN, road_num),
    names_glue  = "{.name}_road{road_num}"
  )

cat("Roadway wide rows:", format(nrow(all_roadway_wide), big.mark = ","), "\n")
cat("Roadway wide cols:", ncol(all_roadway_wide), "\n")
```

```{r}
# Join all three tables
crash_master <- all_crashes %>%
  left_join(all_flags,        by = "CRN", suffix = c("", "_flag")) %>%
  left_join(all_roadway_wide, by = "CRN")

cat("✓ Joined:", format(nrow(crash_master), big.mark = ","), "records,", ncol(crash_master), "columns\n")
```
## Filter to Philadelphia

```{r}
# Check what the county field looks like first
head(crash_master$COUNTY, 20)

philly_crashes <- crash_master %>%
  filter(COUNTY == "67")

cat("Total crashes:", format(nrow(philly_crashes), big.mark = ","), "\n")
cat("Unique CRNs:  ", format(n_distinct(philly_crashes$CRN), big.mark = ","), "\n")
table(philly_crashes$CRASH_YEAR)
```

# 2. Crash Data Check

```{r}
cat("CRASH rows:",   format(nrow(philly_crashes), big.mark = ","), "\n")
cat("CRASH cols:",   ncol(philly_crashes), "\n")
cat("Date range:",   min(philly_crashes$CRASH_YEAR), "-", max(philly_crashes$CRASH_YEAR), "\n")

philly_crashes <- philly_crashes %>%
  mutate(
    LANE_COUNT_1_road1 = case_when(
      LANE_COUNT_1_road1 == "99" ~ NA_character_,
      TRUE ~ LANE_COUNT_1_road1
    ),
    lane_count_clean = as.integer(LANE_COUNT_1_road1)
  )

table(philly_crashes$lane_count_clean, useNA = "always")

```
36093 records do not have lane count data

```{r}
# What road design variables actually have enough coverage to use?
philly_crashes %>%
  summarise(
    pct_has_hour       = mean(!is.na(HOUR_OF_DAY)) * 100,
    pct_has_coords     = mean(!is.na(DEC_LATITUDE)) * 100,
    pct_has_lanes      = mean(!is.na(LANE_COUNT_1_road1)) * 100,
    pct_has_speedlimit = mean(!is.na(SPEED_LIMIT_1_road1)) * 100,
    pct_ksi            = mean(FATAL_OR_SUSP_SERIOUS_INJ == "1", na.rm = TRUE) * 100
  )

table(philly_crashes$LANE_COUNT_1_road1, useNA = "always")
table(philly_crashes$SPEED_LIMIT_1_road1, useNA = "always")
```

```{r}
# How many have time data?
cat("Has TIME_OF_DAY:", sum(!is.na(philly_crashes$TIME_OF_DAY)), "\n")
cat("Percentage:     ", round(mean(!is.na(philly_crashes$TIME_OF_DAY)) * 100, 1), "%\n")

# What does it look like?
philly_crashes %>%
  filter(!is.na(TIME_OF_DAY)) %>%
  select(CRN, CRASH_YEAR, TIME_OF_DAY, HOUR_OF_DAY) %>%
  head(20)

philly_crashes %>%
  filter(!is.na(TIME_OF_DAY)) %>%
  select(CRN, CRASH_YEAR, TIME_OF_DAY, HOUR_OF_DAY) %>%
  head(20)

philly_crashes %>%
  group_by(CRASH_YEAR) %>%
  summarise(
    total         = n(),
    has_time      = sum(!is.na(TIME_OF_DAY)),
    pct_has_time  = round(mean(!is.na(TIME_OF_DAY)) * 100, 1)
  )
```
Using DISPATCH_TM wherever TIME_OF_DAY is NA.

## Fix hour of crash

```{r}
# TIME_OF_DAY is 4-digit military time (e.g. "1746" = 5:46 PM)
# DISPATCH_TM is fallback where TIME_OF_DAY is NA
# Extract first two characters as hour in both cases

philly_crashes <- philly_crashes %>%
  mutate(
    hour_source = case_when(
      !is.na(TIME_OF_DAY) ~ "TIME_OF_DAY",
      !is.na(ARRIVAL_TM)  ~ "DISPATCH_TM",
      TRUE                ~ "missing"
    ),
    hour_raw = case_when(
      !is.na(TIME_OF_DAY) ~ str_sub(as.character(TIME_OF_DAY), 1, 2),
      !is.na(ARRIVAL_TM)  ~ str_sub(as.character(DISPATCH_TM),  1, 2),
      TRUE                ~ NA_character_
    ),
    HOUR_OF_DAY_CLEAN = as.integer(hour_raw)
  )

# Sanity check
cat("Hour coverage by source:\n")
table(philly_crashes$hour_source)

cat("\nHour values (should be 0-23):\n")
table(philly_crashes$HOUR_OF_DAY_CLEAN, useNA = "always")
```

Even then there are 12339 records that do not have time of day

Keep it - to show clustering; can be filtered out from temporal analysis

# 3. Feature Engineering

```{r}
philly_crashes <- philly_crashes %>%
  mutate(
    # KSI flag
    is_ksi = if_else(FATAL_OR_SUSP_SERIOUS_INJ == "1", 1, 0, missing = 0),

    # Time period
    time_period = case_when(
      is.na(HOUR_OF_DAY_CLEAN)                                    ~ "Unknown",
      HOUR_OF_DAY_CLEAN >= 6  & HOUR_OF_DAY_CLEAN < 9            ~ "AM Peak (6-9)",
      HOUR_OF_DAY_CLEAN >= 9  & HOUR_OF_DAY_CLEAN < 16           ~ "Midday (9-16)",
      HOUR_OF_DAY_CLEAN >= 16 & HOUR_OF_DAY_CLEAN < 19           ~ "PM Peak (16-19)",
      HOUR_OF_DAY_CLEAN >= 19 & HOUR_OF_DAY_CLEAN < 22           ~ "Evening (19-22)",
      HOUR_OF_DAY_CLEAN >= 22 | HOUR_OF_DAY_CLEAN < 6            ~ "Night/Late (22-6)",
      TRUE                                                        ~ "Other"
    ),

    # Peak binary
    is_peak = if_else(
      time_period %in% c("AM Peak (6-9)", "PM Peak (16-19)"), 1, 0, missing = 0
    ),

    # Day of week
    day_name = case_when(
      DAY_OF_WEEK == 1 ~ "Sunday",
      DAY_OF_WEEK == 2 ~ "Monday",
      DAY_OF_WEEK == 3 ~ "Tuesday",
      DAY_OF_WEEK == 4 ~ "Wednesday",
      DAY_OF_WEEK == 5 ~ "Thursday",
      DAY_OF_WEEK == 6 ~ "Friday",
      DAY_OF_WEEK == 7 ~ "Saturday",
      TRUE             ~ NA_character_
    ),

    is_weekend = if_else(DAY_OF_WEEK %in% c(1, 7), 1, 0, missing = 0),

    # Severity label
    severity_label = case_when(
      MAX_SEVERITY_LEVEL == "1" ~ "Fatal",
      MAX_SEVERITY_LEVEL == "2" ~ "Suspected Serious Injury",
      MAX_SEVERITY_LEVEL == "3" ~ "Suspected Minor Injury",
      MAX_SEVERITY_LEVEL == "4" ~ "Possible Injury",
      MAX_SEVERITY_LEVEL == "0" ~ "PDO",
      TRUE                      ~ "Unknown"
    ),

    # FLAGS to integer
    PEDESTRIAN            = as.integer(PEDESTRIAN),
    BICYCLE               = as.integer(BICYCLE),
    VULNERABLE_ROAD_USER = as.integer(VULNERABLE_ROAD_USER),
    SPEEDING_RELATED      = as.integer(SPEEDING_RELATED),
    ALCOHOL_RELATED       = as.integer(ALCOHOL_RELATED),
    AGGRESSIVE_DRIVING    = as.integer(AGGRESSIVE_DRIVING),
    ILLUMINATION_DARK     = as.integer(ILLUMINATION_DARK),

    # Coordinate validity
    has_valid_coords = !is.na(DEC_LATITUDE) & !is.na(DEC_LONGITUDE),

    # Road design variables cleaned
    speed_limit  = as.integer(SPEED_LIMIT_1_road1),
    lane_count   = case_when(
      LANE_COUNT_1_road1 == "99" ~ NA_integer_,
      TRUE                       ~ as.integer(LANE_COUNT_1_road1)
    ),

    # High capacity road flag (4+ lanes OR 35+ mph speed limit)
    is_high_capacity = if_else(
      (!is.na(lane_count)  & lane_count  >= 4) |
      (!is.na(speed_limit) & speed_limit >= 35),
      1, 0, missing = 0
    )
  ) %>%
  mutate(
    time_period = factor(time_period,
                        levels = c("AM Peak (6-9)", "Midday (9-16)", "PM Peak (16-19)",
                                   "Evening (19-22)", "Night/Late (22-6)", "Unknown")),
    day_name = factor(day_name,
                     levels = c("Monday", "Tuesday", "Wednesday",
                                "Thursday", "Friday", "Saturday", "Sunday")),
    severity_label = factor(severity_label,
                           levels = c("Fatal", "Suspected Serious Injury",
                                      "Suspected Minor Injury", "Possible Injury",
                                      "PDO", "Unknown"))
  )

cat("\n✓ Feature engineering complete\n")
cat("Total crashes:     ", format(nrow(philly_crashes), big.mark = ","), "\n")
cat("KSI crashes:       ", format(sum(philly_crashes$is_ksi), big.mark = ","),
    " (", round(mean(philly_crashes$is_ksi) * 100, 1), "%)\n", sep = "")
cat("Has hour data:     ", format(sum(!is.na(philly_crashes$HOUR_OF_DAY_CLEAN)), big.mark = ","),
    " (", round(mean(!is.na(philly_crashes$HOUR_OF_DAY_CLEAN)) * 100, 1), "%)\n", sep = "")
cat("Has valid coords:  ", format(sum(philly_crashes$has_valid_coords), big.mark = ","),
    " (", round(mean(philly_crashes$has_valid_coords) * 100, 1), "%)\n", sep = "")

```
#4. PART 1: TEMPORAL PATTERNS

```{r}
# Subset to crashes with known time
crashes_timed <- philly_crashes %>%
  filter(!is.na(HOUR_OF_DAY_CLEAN))

cat("Crashes with known time:", format(nrow(crashes_timed), big.mark = ","),
    "(", round(nrow(crashes_timed) / nrow(philly_crashes) * 100, 1), "%)\n\n")


# 1a. Hourly crash volume and KSI rate ------------------------------------

hourly_summary <- crashes_timed %>%
  group_by(HOUR_OF_DAY_CLEAN) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  )

p1a <- ggplot(hourly_summary, aes(x = HOUR_OF_DAY_CLEAN, y = total_crashes)) +
  annotate("rect", xmin = 6,  xmax = 9,  ymin = 0, ymax = Inf, alpha = 0.15, fill = "orange") +
  annotate("rect", xmin = 16, xmax = 19, ymin = 0, ymax = Inf, alpha = 0.15, fill = "red") +
  geom_col(fill = "steelblue", alpha = 0.8) +
  scale_x_continuous(breaks = seq(0, 23, 2)) +
  scale_y_continuous(labels = comma) +
  labs(
    title    = "Crash Volume by Hour of Day",
    subtitle = "Orange = AM Peak (6-9), Red = PM Peak (16-19)",
    x        = "Hour of Day",
    y        = "Number of Crashes",
    caption  = "Source: PennDOT Crash Database 2020-2024"
  ) +
  plotTheme

p1b <- ggplot(hourly_summary, aes(x = HOUR_OF_DAY_CLEAN, y = ksi_rate)) +
  annotate("rect", xmin = 6,  xmax = 9,  ymin = 0, ymax = Inf, alpha = 0.15, fill = "orange") +
  annotate("rect", xmin = 16, xmax = 19, ymin = 0, ymax = Inf, alpha = 0.15, fill = "red") +
  geom_line(color = "darkred", linewidth = 1.2) +
  geom_point(color = "darkred", size = 2.5) +
  geom_hline(yintercept = mean(hourly_summary$ksi_rate),
             linetype = "dashed", color = "gray50", linewidth = 0.8) +
  scale_x_continuous(breaks = seq(0, 23, 2)) +
  labs(
    title    = "KSI Rate by Hour of Day",
    subtitle = sprintf("Dashed line = average KSI rate (%.1f%%)", mean(hourly_summary$ksi_rate)),
    x        = "Hour of Day",
    y        = "KSI Rate (%)",
    caption  = "KSI = Killed or Suspected Serious Injury"
  ) +
  plotTheme

p1a + p1b +
  plot_annotation(
    title = "Temporal Patterns of Philadelphia Crashes (2020-2024)",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )


# 1b. Crashes by day of week ----------------------------------------------

day_summary <- crashes_timed %>%
  filter(!is.na(day_name)) %>%
  group_by(day_name, is_weekend) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  )

p1c <- ggplot(day_summary, aes(x = day_name, y = total_crashes, fill = factor(is_weekend))) +
  geom_col(alpha = 0.8) +
  scale_fill_manual(
    values = c("0" = "steelblue", "1" = "coral"),
    labels = c("Weekday", "Weekend"),
    name   = NULL
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Crash Volume by Day of Week",
    x     = NULL,
    y     = "Number of Crashes"
  ) +
  plotTheme

p1d <- ggplot(day_summary, aes(x = day_name, y = ksi_rate, fill = factor(is_weekend))) +
  geom_col(alpha = 0.8, show.legend = FALSE) +
  scale_fill_manual(values = c("0" = "steelblue", "1" = "coral")) +
  labs(
    title = "KSI Rate by Day of Week",
    x     = NULL,
    y     = "KSI Rate (%)"
  ) +
  plotTheme

p1c + p1d +
  plot_annotation(
    title = "Crash Patterns by Day of Week",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )


# 1c. Time period summary table -------------------------------------------

period_summary <- crashes_timed %>%
  filter(time_period != "Unknown") %>%
  group_by(time_period) %>%
  summarise(
    total_crashes    = n(),
    ksi_crashes      = sum(is_ksi, na.rm = TRUE),
    ksi_rate         = round(ksi_crashes / total_crashes * 100, 2),
    speeding_crashes = sum(SPEEDING_RELATED == 1, na.rm = TRUE),
    speeding_rate    = round(speeding_crashes / total_crashes * 100, 2),
    ped_crashes      = sum(PEDESTRIAN == 1, na.rm = TRUE),
    bike_crashes     = sum(BICYCLE == 1, na.rm = TRUE),
    .groups          = "drop"
  ) %>%
  arrange(desc(ksi_rate))

cat("Crash characteristics by time period:\n")
print(period_summary)
```

#5. CRASH SEVERITY - Testing Peak vs Off-Peak Hypothesis

```{r}
peak_comparison <- crashes_timed %>%
  filter(!is.na(is_peak)) %>%
  mutate(period_type = if_else(is_peak == 1, "Peak Hours", "Off-Peak Hours")) %>%
  group_by(period_type) %>%
  summarise(
    total_crashes    = n(),
    ksi_crashes      = sum(is_ksi, na.rm = TRUE),
    fatal_crashes    = sum(FATAL_COUNT > 0, na.rm = TRUE),
    speeding_crashes = sum(SPEEDING_RELATED == 1, na.rm = TRUE),
    ped_crashes      = sum(PEDESTRIAN == 1, na.rm = TRUE),
    dark_crashes     = sum(ILLUMINATION_DARK == 1, na.rm = TRUE),
    .groups          = "drop"
  ) %>%
  mutate(
    ksi_rate      = ksi_crashes      / total_crashes * 100,
    fatal_rate    = fatal_crashes    / total_crashes * 100,
    speeding_rate = speeding_crashes / total_crashes * 100,
    ped_rate      = ped_crashes      / total_crashes * 100,
    dark_rate     = dark_crashes     / total_crashes * 100
  )

cat("Peak vs Off-Peak Comparison:\n")
print(peak_comparison %>% select(period_type, total_crashes, ksi_rate, speeding_rate, ped_rate))
```

```{r}
# Statistical test
ksi_test <- prop.test(
  x = c(peak_comparison$ksi_crashes[peak_comparison$period_type == "Off-Peak Hours"],
        peak_comparison$ksi_crashes[peak_comparison$period_type == "Peak Hours"]),
  n = c(peak_comparison$total_crashes[peak_comparison$period_type == "Off-Peak Hours"],
        peak_comparison$total_crashes[peak_comparison$period_type == "Peak Hours"])
)

cat("\nStatistical Test (KSI Rate Difference):\n")
cat("X² =", round(ksi_test$statistic, 2), "\n")
cat("p-value =", format(ksi_test$p.value, scientific = FALSE, digits = 4), "\n")

if (ksi_test$p.value < 0.05) {
  cat("✓ Difference is statistically significant (p < 0.05)\n\n")
} else {
  cat("✗ Difference is NOT statistically significant (p >= 0.05)\n\n")
}

```

```{r}

# Bar chart: KSI rate peak vs off-peak
p2a <- ggplot(peak_comparison, aes(x = period_type, y = ksi_rate, fill = period_type)) +
  geom_col(alpha = 0.85, show.legend = FALSE) +
  geom_text(aes(label = sprintf("%.1f%%", ksi_rate)),
            vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_manual(values = c("Peak Hours" = "steelblue", "Off-Peak Hours" = "darkred")) +
  labs(
    title    = "KSI Rate: Peak vs Off-Peak Hours",
    subtitle = sprintf("p = %.4f — difference is %s",
                       ksi_test$p.value,
                       if_else(ksi_test$p.value < 0.05, "statistically significant", "not significant")),
    x        = NULL,
    y        = "KSI Rate (%)",
    caption  = "KSI = Killed or Suspected Serious Injury"
  ) +
  plotTheme +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

# Multi-metric comparison
peak_long <- peak_comparison %>%
  select(period_type, ksi_rate, speeding_rate, ped_rate, dark_rate) %>%
  pivot_longer(-period_type, names_to = "metric", values_to = "rate") %>%
  mutate(metric = recode(metric,
    "ksi_rate"      = "KSI Rate",
    "speeding_rate" = "Speeding Related",
    "ped_rate"      = "Pedestrian Involved",
    "dark_rate"     = "Dark Conditions"
  ))

p2b <- ggplot(peak_long, aes(x = metric, y = rate, fill = period_type)) +
  geom_col(position = "dodge", alpha = 0.85) +
  scale_fill_manual(
    values = c("Peak Hours" = "steelblue", "Off-Peak Hours" = "darkred"),
    name   = NULL
  ) +
  labs(
    title    = "Crash Characteristics: Peak vs Off-Peak",
    subtitle = "Rate (%) of crashes with each characteristic",
    x        = NULL,
    y        = "Rate (%)"
  ) +
  plotTheme +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

p2a + p2b +
  plot_annotation(
    title = "Testing the Off-Peak Safety Hypothesis",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )


# 2b. KSI rate by hour - the core visual ----------------------------------

p2c <- ggplot(hourly_summary, aes(x = HOUR_OF_DAY_CLEAN, y = ksi_rate)) +
  annotate("rect", xmin = 6,  xmax = 9,  ymin = 0, ymax = Inf,
           alpha = 0.15, fill = "orange", label = "AM Peak") +
  annotate("rect", xmin = 16, xmax = 19, ymin = 0, ymax = Inf,
           alpha = 0.15, fill = "orange") +
  annotate("text", x = 7.5,  y = max(hourly_summary$ksi_rate) * 0.95,
           label = "AM\nPeak", size = 3, color = "darkorange") +
  annotate("text", x = 17.5, y = max(hourly_summary$ksi_rate) * 0.95,
           label = "PM\nPeak", size = 3, color = "darkorange") +
  geom_line(color = "darkred", linewidth = 1.5) +
  geom_point(aes(size = total_crashes), color = "darkred", alpha = 0.7) +
  geom_hline(yintercept = mean(hourly_summary$ksi_rate),
             linetype = "dashed", color = "gray40") +
  scale_x_continuous(breaks = seq(0, 23, 2)) +
  scale_size_continuous(name = "Total crashes", range = c(2, 8)) +
  labs(
    title    = "KSI Rate by Hour of Day",
    subtitle = "Point size = crash volume. Off-peak hours show elevated severity.",
    x        = "Hour of Day",
    y        = "KSI Rate (%)",
    caption  = "Source: PennDOT Crash Database, Philadelphia County 2020-2024"
  ) +
  plotTheme

print(p2c)
```

```{r}

# 2c. Severity distribution by time period --------------------------------

severity_by_period <- crashes_timed %>%
  filter(time_period != "Unknown", severity_label != "Unknown") %>%
  group_by(time_period, severity_label) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(time_period) %>%
  mutate(pct = n / sum(n) * 100) %>%
  ungroup()

p2d <- ggplot(severity_by_period,
              aes(x = time_period, y = pct, fill = severity_label)) +
  geom_col(position = "stack", alpha = 0.85) +
  scale_fill_manual(values = severity_colors, name = "Severity") +
  labs(
    title    = "Severity Distribution by Time Period",
    subtitle = "Fatal and serious injury crashes are concentrated in off-peak hours",
    x        = NULL,
    y        = "Share of Crashes (%)",
    caption  = "Source: PennDOT Crash Database, Philadelphia County 2020-2024"
  ) +
  plotTheme

print(p2d)
```

# 6. Road Design and Crash Severity

## 6.1. Check Coverage

```{r}
cat("Speed limit coverage: ", round(mean(!is.na(philly_crashes$speed_limit)) * 100, 1), "%\n")
cat("Lane count coverage:  ", round(mean(!is.na(philly_crashes$lane_count)) * 100, 1), "%\n\n")
```

- Speed limit coverage:  90.6 %

- Lane count coverage:   20.8 %

## 6.2. KSI rate by speed limit

```{r}
speed_summary <- philly_crashes %>%
  filter(!is.na(speed_limit), speed_limit >= 10, speed_limit <= 60) %>%
  group_by(speed_limit) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  ) %>%
  filter(total_crashes >= 30)  # Only speed limits with enough data

p3a <- ggplot(speed_summary, aes(x = factor(speed_limit), y = ksi_rate)) +
  geom_col(fill = "steelblue", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f%%", ksi_rate)),
            vjust = -0.5, size = 3.5) +
  labs(
    title    = "KSI Rate by Speed Limit",
    subtitle = "Higher speed limits associated with more severe crashes",
    x        = "Posted Speed Limit (mph)",
    y        = "KSI Rate (%)",
    caption  = "Only speed limits with 30+ crashes shown"
  ) +
  plotTheme
```

## 6.3. KSI rate by lane count

```{r}
lane_summary <- philly_crashes %>%
  filter(!is.na(lane_count), lane_count >= 1, lane_count <= 8) %>%
  group_by(lane_count) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  ) %>%
  filter(total_crashes >= 30)

p3b <- ggplot(lane_summary, aes(x = factor(lane_count), y = ksi_rate)) +
  geom_col(fill = "steelblue", alpha = 0.8) +
  geom_text(aes(label = sprintf("%.1f%%", ksi_rate)),
            vjust = -0.5, size = 3.5) +
  labs(
    title    = "KSI Rate by Number of Lanes",
    subtitle = "Roads with more lanes show different severity patterns",
    x        = "Number of Lanes",
    y        = "KSI Rate (%)",
    caption  = "Only lane counts with 30+ crashes shown"
  ) +
  plotTheme

p3a + p3b +
  plot_annotation(
    title = "Road Design Characteristics and Crash Severity",
    theme = theme(plot.title = element_text(size = 16, face = "bold"))
  )
```

## 6.4. Speed Limit x Peak/ Off-peak

```{r}
speed_peak_summary <- crashes_timed %>%
  filter(!is.na(speed_limit), speed_limit >= 10, speed_limit <= 60,
         !is.na(is_peak)) %>%
  mutate(period_type = if_else(is_peak == 1, "Peak Hours", "Off-Peak Hours")) %>%
  group_by(speed_limit, period_type) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  ) %>%
  filter(total_crashes >= 20)

p3c <- ggplot(speed_peak_summary,
              aes(x = factor(speed_limit), y = ksi_rate, fill = period_type)) +
  geom_col(position = "dodge", alpha = 0.85) +
  scale_fill_manual(
    values = c("Peak Hours" = "steelblue", "Off-Peak Hours" = "darkred"),
    name   = NULL
  ) +
  labs(
    title    = "KSI Rate by Speed Limit and Time of Day",
    subtitle = "Does off-peak severity advantage grow on higher-speed roads?",
    x        = "Posted Speed Limit (mph)",
    y        = "KSI Rate (%)",
    caption  = "Source: PennDOT Crash Database, Philadelphia County 2020-2024"
  ) +
  plotTheme

print(p3c)
```

## 6.5. Lane Count x Peak/ Off-peak

```{r}
lane_peak_summary <- crashes_timed %>%
  filter(!is.na(lane_count), lane_count >= 1, lane_count <= 8,
         !is.na(is_peak)) %>%
  mutate(period_type = if_else(is_peak == 1, "Peak Hours", "Off-Peak Hours")) %>%
  group_by(lane_count, period_type) %>%
  summarise(
    total_crashes = n(),
    ksi_crashes   = sum(is_ksi, na.rm = TRUE),
    ksi_rate      = ksi_crashes / total_crashes * 100,
    .groups       = "drop"
  ) %>%
  filter(total_crashes >= 20)

p3d <- ggplot(lane_peak_summary,
              aes(x = factor(lane_count), y = ksi_rate, fill = period_type)) +
  geom_col(position = "dodge", alpha = 0.85) +
  scale_fill_manual(
    values = c("Peak Hours" = "steelblue", "Off-Peak Hours" = "darkred"),
    name   = NULL
  ) +
  labs(
    title    = "KSI Rate by Lane Count and Time of Day",
    subtitle = "Does off-peak severity grow on wider roads?",
    x        = "Number of Lanes",
    y        = "KSI Rate (%)",
    caption  = "Source: PennDOT Crash Database, Philadelphia County 2020-2024"
  ) +
  plotTheme

p3c + p3d +
  plot_annotation(
    title    = "Road Design × Temporal Interaction",
    subtitle = "Testing whether high-capacity roads are more dangerous off-peak",
    theme    = theme(
      plot.title    = element_text(size = 16, face = "bold"),
      plot.subtitle = element_text(size = 12)
    )
  )
```

## 6.6 Summary - Key Findings

```{r}
cat("1. TEMPORAL\n")
cat("   Highest KSI hour:  ", hourly_summary$HOUR_OF_DAY_CLEAN[which.max(hourly_summary$ksi_rate)], ":00\n")
cat("   Lowest  KSI hour:  ", hourly_summary$HOUR_OF_DAY_CLEAN[which.min(hourly_summary$ksi_rate)], ":00\n\n")

cat("2. HYPOTHESIS TEST\n")
off_peak_ksi <- peak_comparison$ksi_rate[peak_comparison$period_type == "Off-Peak Hours"]
peak_ksi     <- peak_comparison$ksi_rate[peak_comparison$period_type == "Peak Hours"]
cat("   Peak KSI rate:     ", round(peak_ksi, 2), "%\n")
cat("   Off-peak KSI rate: ", round(off_peak_ksi, 2), "%\n")
cat("   Difference:        ", round(off_peak_ksi - peak_ksi, 2), "percentage points\n")
cat("   p-value:           ", format(ksi_test$p.value, digits = 4), "\n\n")

cat("3. ROAD DESIGN\n")
cat("   Speed limit range: ", min(speed_summary$speed_limit), "-",
    max(speed_summary$speed_limit), "mph\n")
cat("   Highest KSI speed limit:", speed_summary$speed_limit[which.max(speed_summary$ksi_rate)], "mph\n")
```